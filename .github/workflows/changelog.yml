name: Generate Changelog
on:
  push:
    branches:
      - main  # Runs on pushes to main branch
  release:
    types: [published]  # Runs when a new release is published

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetches full Git history for tags

      - name: Generate Changelog
        uses: mikepenz/release-changelog-builder-action@v3
        id: changelog
        with:
          fail_if_no_releases: false  # Add this to prevent failure when no tags exist
          configuration: |
            untagged: "Unreleased Changes"  # Add this to group untagged commits
            categories:
              - title: "ðŸš€ Features"
                labels:
                  - "feature"
                  - "enhancement"
              - title: "ðŸ› Bug Fixes"
                labels:
                  - "bug"
                  - "fix"
              - title: "ðŸ“š Documentation"
                labels:
                  - "documentation"
              - title: "ðŸ§¹ Maintenance"
                labels:
                  - "chore"
                  - "refactor"
            ignore_labels:
              - "wip"
              - "draft"
            template: |
              # Changelog

              {{#if releases}}
                {{#each releases}}
                  ## {{title}} ({{date}})
                  {{#if merges}}
                    ### Merged Pull Requests
                    {{#each merges}}
                      - {{message}} ({{id}})
                    {{/each}}
                  {{/if}}
                  {{#if fixes}}
                    ### Fixed Issues
                    {{#each fixes}}
                      - {{commit.subject}} ({{id}})
                    {{/each}}
                  {{/if}}
                  {{#each commits}}
                    - {{subject}} ([{{sha}}]({{href}})) by **{{author}}**
                  {{/each}}
                {{/each}}
              {{else}}
                ## Unreleased Changes
                {{#each commits}}
                  - {{subject}} ([{{sha}}]({{href}})) by **{{author}}**
                {{/each}}
              {{/if}}

      - name: Save Changelog to File
        run: |
          echo "${{ steps.changelog.outputs.changelog }}" > CHANGELOG.md

      - name: Commit and Push Changelog
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add CHANGELOG.md
          git commit -m "ðŸ“œ Update CHANGELOG.md [skip ci]"
          git push
